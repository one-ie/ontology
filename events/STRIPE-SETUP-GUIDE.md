# Stripe Integration Setup Guide

Complete guide for setting up Stripe payments in the ONE Platform.

## Quick Start

### 1. Get Your Stripe API Keys

1. Sign up for a Stripe account at https://stripe.com
2. Navigate to **Developers → API Keys**
3. Copy your **Publishable key** (starts with `pk_test_` for test mode)
4. Copy your **Secret key** (starts with `sk_test_` for test mode)

### 2. Add Keys to Environment Variables

Add to `.env.local`:

```bash
# Stripe Test Keys (for development)
PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51...
STRIPE_SECRET_KEY=sk_test_51...

# Course price (will be generated)
STRIPE_COURSE_PRICE_ID=price_...
```

### 3. Create Products and Prices

Run the automated setup script:

```bash
bun run stripe:setup
```

This will:
- ✅ Create products in your Stripe account
- ✅ Generate price IDs for each product
- ✅ Save configuration to `.stripe-config.json`
- ✅ Output the environment variables you need

### 4. Add Generated Price IDs

Copy the output from the setup script and add to `.env.local`:

```bash
STRIPE_COURSE_PRICE_ID=price_0SKcI6qs14Mpveu16vIPzJbH
```

### 5. Test the Integration

Start your dev server:

```bash
bun run dev
```

Visit: http://localhost:4321/pay-course

You should be redirected to Stripe Checkout. Use test cards:

- **Success**: `4242 4242 4242 4242`
- **Decline**: `4000 0000 0000 0002`
- **3D Secure**: `4000 0025 0000 3155`

Use any future expiry date, any 3-digit CVC, and any ZIP code.

## Architecture

### Overview

```
Frontend (Astro) → Stripe Checkout → Success/Cancel Pages
```

**Key Files:**

- `src/pages/pay-course.astro` - Checkout page (creates session)
- `src/pages/thankyou-course.astro` - Success page
- `src/lib/stripe.ts` - Stripe utilities
- `scripts/setup-stripe-products.ts` - Product setup script
- `.stripe-config.json` - Generated product configuration

### Checkout Flow

1. **User visits `/pay-course`**
   - Server-side code creates Stripe Checkout Session
   - Uses `STRIPE_COURSE_PRICE_ID` from environment
   - Sets success/cancel URLs

2. **User redirected to Stripe**
   - Secure Stripe Checkout UI
   - Handles payment processing
   - Validates card details

3. **Payment succeeds**
   - User redirected to `/thankyou-course?session_id={CHECKOUT_SESSION_ID}`
   - Session ID can be used to verify payment

4. **Payment fails or cancelled**
   - User redirected to `/stripe` (cancel URL)

## Product Configuration

### Default Product

The setup script creates one product by default:

```typescript
{
  name: 'ONE Platform Course',
  description: 'Complete course on building with the ONE Platform',
  price: $97.00 USD
}
```

### Adding More Products

Edit `scripts/setup-stripe-products.ts`:

```typescript
const PRODUCTS = [
  {
    name: 'ONE Platform Course',
    description: 'Complete course...',
    images: ['https://one.ie/images/course.jpg'],
    defaultPrice: {
      currency: 'usd',
      unitAmount: 9700, // $97.00
      nickname: 'ONE Course - One-time Payment',
    },
  },
  // Add new product
  {
    name: 'Pro Membership',
    description: 'Monthly pro membership',
    images: ['https://one.ie/images/pro.jpg'],
    defaultPrice: {
      currency: 'usd',
      unitAmount: 2900, // $29.00
      nickname: 'Pro - Monthly',
    },
  },
];
```

Then run:

```bash
bun run stripe:setup
```

This will create ALL products and output new environment variables.

### Recurring Subscriptions

To create a subscription product, modify the price configuration:

```typescript
defaultPrice: {
  currency: 'usd',
  unitAmount: 2900,
  recurring: {
    interval: 'month', // or 'year'
  },
  nickname: 'Pro - Monthly Subscription',
}
```

Then update your checkout session:

```typescript
session = await stripe.checkout.sessions.create({
  mode: 'subscription', // Change from 'payment'
  line_items: [
    {
      price: import.meta.env.STRIPE_PRO_PRICE_ID,
      quantity: 1,
    },
  ],
  success_url: `${origin}/thankyou?session_id={CHECKOUT_SESSION_ID}`,
  cancel_url: `${origin}/pricing`,
});
```

## Environment Variables Reference

### Required

```bash
# Publishable key (client-side)
PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51...

# Secret key (server-side only, NEVER expose to client)
STRIPE_SECRET_KEY=sk_test_51...

# Product price IDs (generated by stripe:setup)
STRIPE_COURSE_PRICE_ID=price_...
```

### Optional

```bash
# Webhook signing secret (for production webhooks)
STRIPE_WEBHOOK_SECRET=whsec_...

# Additional product price IDs
STRIPE_PRO_PRICE_ID=price_...
STRIPE_ENTERPRISE_PRICE_ID=price_...
```

## Security Best Practices

### ✅ DO

- **Use test keys in development** (`sk_test_...`)
- **Use live keys in production** (`sk_live_...`)
- **Keep secret keys in `.env.local`** (never commit)
- **Validate on server-side** (don't trust client data)
- **Use webhooks** to verify payments in production
- **Enable Stripe Radar** for fraud detection

### ❌ DON'T

- **Never expose secret keys** to client-side code
- **Never commit `.env.local`** to git
- **Never trust payment status** without server verification
- **Never skip webhook signature validation** in production

## Testing

### Test Card Numbers

Stripe provides test cards for various scenarios:

| Card Number | Scenario |
|-------------|----------|
| `4242 4242 4242 4242` | Success |
| `4000 0000 0000 0002` | Card declined |
| `4000 0025 0000 3155` | Requires 3D Secure authentication |
| `4000 0000 0000 9995` | Insufficient funds |
| `4000 0000 0000 0069` | Charge expired |

**Expiry**: Use any future date (e.g., `12/34`)
**CVC**: Use any 3 digits (e.g., `123`)
**ZIP**: Use any ZIP code (e.g., `12345`)

### Test Mode vs Live Mode

**Test Mode** (Development):
- Uses `sk_test_...` and `pk_test_...` keys
- No real money involved
- Data is isolated from production
- Can use test card numbers

**Live Mode** (Production):
- Uses `sk_live_...` and `pk_live_...` keys
- Real payments are processed
- Real money is transferred
- Must use real payment methods

**Toggle in Stripe Dashboard**: Top-left corner "View test data" switch

## Webhooks (Production)

For production, set up webhooks to handle payment events:

### 1. Create Webhook Endpoint

Create `src/pages/api/webhooks/stripe.ts`:

```typescript
import type { APIRoute } from 'astro';
import Stripe from 'stripe';

const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2025-02-24.acacia',
});

export const POST: APIRoute = async ({ request }) => {
  const body = await request.text();
  const sig = request.headers.get('stripe-signature')!;

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(
      body,
      sig,
      import.meta.env.STRIPE_WEBHOOK_SECRET!
    );
  } catch (err) {
    return new Response(`Webhook Error: ${err.message}`, { status: 400 });
  }

  // Handle the event
  switch (event.type) {
    case 'checkout.session.completed':
      const session = event.data.object as Stripe.Checkout.Session;
      // Fulfill order, grant access, etc.
      console.log('Payment succeeded:', session.id);
      break;
    case 'payment_intent.payment_failed':
      const failedPayment = event.data.object as Stripe.PaymentIntent;
      console.log('Payment failed:', failedPayment.id);
      break;
    default:
      console.log(`Unhandled event type ${event.type}`);
  }

  return new Response(JSON.stringify({ received: true }), { status: 200 });
};
```

### 2. Configure Webhook in Stripe Dashboard

1. Go to **Developers → Webhooks**
2. Click **Add endpoint**
3. Enter URL: `https://yourdomain.com/api/webhooks/stripe`
4. Select events to listen to:
   - `checkout.session.completed`
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`
5. Copy the **Signing secret** (starts with `whsec_`)
6. Add to `.env.local`:
   ```bash
   STRIPE_WEBHOOK_SECRET=whsec_...
   ```

### 3. Test Webhooks Locally

Use Stripe CLI:

```bash
# Install Stripe CLI
brew install stripe/stripe-cli/stripe

# Login
stripe login

# Forward webhooks to local dev server
stripe listen --forward-to localhost:4321/api/webhooks/stripe
```

This gives you a webhook signing secret for testing.

## Troubleshooting

### Error: "No such price: price_..."

**Solution**: Run the setup script again:

```bash
bun run stripe:setup
```

Then copy the generated `STRIPE_COURSE_PRICE_ID` to `.env.local`.

### Error: "STRIPE_COURSE_PRICE_ID is not configured"

**Solution**: Add the price ID to `.env.local`:

```bash
STRIPE_COURSE_PRICE_ID=price_0SKcI6qs14Mpveu16vIPzJbH
```

### Error: "Stripe secret key is not configured"

**Solution**: Add your Stripe secret key to `.env.local`:

```bash
STRIPE_SECRET_KEY=sk_test_51...
```

Get it from: https://dashboard.stripe.com/test/apikeys

### Checkout redirects immediately

**Cause**: Session creation is failing
**Solution**: Check server logs for detailed error message

### Payment succeeds but order not fulfilled

**Cause**: Webhook not configured or failing
**Solution**:
1. Check webhook logs in Stripe Dashboard
2. Verify webhook signature validation
3. Test webhook with Stripe CLI

### Using wrong API version

**Cause**: Stripe API version mismatch
**Solution**: Use the version specified in the code:

```typescript
const stripe = new Stripe(key, {
  apiVersion: '2025-02-24.acacia',
});
```

## Generated Files

The setup script generates:

### `.stripe-config.json`

Product and price configuration:

```json
{
  "environment": "test",
  "createdAt": "2025-10-21T09:55:43.049Z",
  "products": [
    {
      "name": "ONE Platform Course",
      "productId": "prod_THAdytWWNfieJ0",
      "priceId": "price_0SKcI6qs14Mpveu16vIPzJbH",
      "amount": 9700,
      "currency": "usd"
    }
  ]
}
```

**Purpose**: Reference for product IDs and configuration

**Location**: Project root (git-ignored)

## Support

### Stripe Dashboard

View all payments, customers, and events:
- **Test Mode**: https://dashboard.stripe.com/test/payments
- **Live Mode**: https://dashboard.stripe.com/payments

### Stripe Documentation

- [Checkout Documentation](https://stripe.com/docs/payments/checkout)
- [Testing Guide](https://stripe.com/docs/testing)
- [Webhooks Guide](https://stripe.com/docs/webhooks)
- [API Reference](https://stripe.com/docs/api)

### ONE Platform Support

For integration questions:
- GitHub Issues: https://github.com/one-ie/one/issues
- Documentation: https://one.ie/docs

## Next Steps

1. ✅ Set up Stripe account
2. ✅ Add API keys to `.env.local`
3. ✅ Run `bun run stripe:setup`
4. ✅ Test checkout flow
5. ⏭️ Add webhook handling
6. ⏭️ Integrate with Convex for order management
7. ⏭️ Add customer portal
8. ⏭️ Go live with live keys

---

**Built with Stripe Checkout for secure, reliable payments.**
